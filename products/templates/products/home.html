{% extends "base.html" %}
{% load static %}

{% block title %}Home - My Shop{% endblock %}

{% block content %}
<!-- Messages from login -->
<div id="messages-container">
    {% if messages %}
        {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Sidebar for sorting (desktop) -->
<aside id="sidebar">
    <h2>Filters</h2>
    <form method="get" id="filter-form">

        <!-- Search -->
        <input 
            type="text" 
            name="q" 
            placeholder="Search..." 
            class="search-input"
            value="{{ request.GET.q|default_if_none:'' }}"
            onkeydown="if (event.key === 'Enter') { event.preventDefault(); this.form.submit(); }"
        >
        <button type="submit" style="display:none"></button>

        <!-- Sorting -->
        <label for="sort">Sort By:</label>
        <select name="sort" id="sort" onchange="this.form.submit()">
            <option value="">None</option>
            <option value="price-asc" {% if selected_sort == 'price-asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="price-desc" {% if selected_sort == 'price-desc' %}selected{% endif %}>Price: High to Low</option>
            <option value="rating" {% if selected_sort == 'rating' %}selected{% endif %}>Rating</option>
            <option value="AZ" {% if selected_sort == 'AZ' %}selected{% endif %}>A–Z</option>
            <option value="ZA" {% if selected_sort == 'ZA' %}selected{% endif %}>Z–A</option>
        </select>

        <!-- Categories -->
        <label for="category">Category:</label>
        <select name="category" id="category" onchange="this.form.submit()">
            <option value="">None</option>
            {% for cat in categories %}
                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
        </select>

        <button type="submit" name="clear" value="1" style="margin-top:10px;">Clear Filters</button>
    </form>
</aside>

<!-- Mobile sort bar (hidden on desktop) -->
<aside id="mobile-sort">
    <form method="GET">
        <input 
            type="text" 
            name="q" 
            placeholder="Search..." 
            class="search-input"
            value="{{ request.GET.q|default_if_none:'' }}"
            onkeydown="if (event.key === 'Enter') { event.preventDefault(); this.form.submit(); }"
        />
        <button type="submit" style="display:none"></button>

        <label for="sort-select">Sort By:</label>
        <select name="sort" id="sort-select">
            <option value="">Default</option>
            <option value="price-asc" {% if request.GET.sort == 'price-asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="price-desc" {% if request.GET.sort == 'price-desc' %}selected{% endif %}>Price: High to Low</option>
            <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>Rating</option>
            <option value="AZ" {% if request.GET.sort == 'AZ' %}selected{% endif %}>A to Z</option>
            <option value="ZA" {% if request.GET.sort == 'ZA' %}selected{% endif %}>Z to A</option>
        </select>

        <label for="category-select">Category:</label>
        <select name="category" id="category-select">
            <option value="">All</option>
            {% for category in categories %}
                <option value="{{ category }}" {% if request.GET.category == category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>

        <button type="submit">Apply</button>
    </form>
</aside>

<main>
    <div id="products-container">
        {% if products %}
            {% for product in products %}
            <div class="product">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="cardImage">
                {% endif %}

                <div class="product-text">
                    <h2 class="cardName">
                        <a href="{% url 'orders:view_more' product.id %}">{{ product.name }}</a>
                    </h2>

                    <p class="cardPrice">{{ product.price }} $</p>

                    <!-- Stars only -->
                    <p class="cardRate">
                        <span class="stars">
                            {% for star in product.stars %}
                                {% if star == "full" %}
                                    <i class="fa-solid fa-star rating"></i>
                                {% elif star == "half" %}
                                    <i class="fa-solid fa-star-half-stroke rating"></i>
                                {% else %}
                                    <i class="fa-regular fa-star rating"></i>
                                {% endif %}
                            {% endfor %}
                        </span>
                    </p>

                    <p class="cardBrand">{{ product.brand }}</p>
                    <p class="cardCategory">{{ product.category }}</p>

                    <p class="cardStock">
                        {% if product.stock > 0 %}
                            In Stock: {{ product.stock }}
                        {% else %}
                            <span style="color:red;">Out of Stock</span>
                        {% endif %}
                    </p>
                </div>

                <div class="cardButtonWrap">
                    <button class="cardButton" onclick="window.location.href='{% url 'orders:view_more' product.id %}'">
                        View More
                    </button>

                    {% if not user.is_authenticated %}
                        <button class="toCart" disabled title="You need to log in to add to cart">
                            <i class="fa-solid fa-cart-plus cartIcon"></i>
                        </button>
                    {% else %}
                        <button class="toCart"
                            data-product='{
                                "id": {{ product.id }},
                                "name": "{{ product.name|escapejs }}",
                                "price": {{ product.price }},
                                "image": "{% if product.image %}{{ product.image.url|escapejs }}{% else %}""{% endif %}"
                            }'>
                            <i class="fa-solid fa-cart-plus cartIcon"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>No products available.</p>
        {% endif %}
    </div>

    <!-- Pagination -->
    <div id="pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}
        {% if request.GET.q %}&q={{ request.GET.q }}{% endif %}
        {% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}
        {% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">Previous</a>
        {% endif %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}
        {% if request.GET.q %}&q={{ request.GET.q }}{% endif %}
        {% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}
        {% if request.GET.category %}&category={{ request.GET.category }}{% endif %}">Next</a>
        {% endif %}
    </div>
</main>
{% endblock %}
